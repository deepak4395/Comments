name: Diagnose Backend Server

on:
  workflow_dispatch:

jobs:
  diagnose:
    name: Diagnose and Fix Backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Run Full Diagnostic
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          ssh -i ~/.ssh/deploy_key $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            set -e
            
            echo "========================================="
            echo "BACKEND DIAGNOSTIC REPORT"
            echo "========================================="
            echo ""
            
            # 1. Check System Info
            echo "1. SYSTEM INFORMATION"
            echo "---------------------"
            echo "Hostname: $(hostname)"
            echo "OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2)"
            echo "Uptime: $(uptime -p)"
            echo "Memory: $(free -h | grep Mem | awk '{print $3 "/" $2}')"
            echo "Disk: $(df -h / | tail -1 | awk '{print $3 "/" $2 " (" $5 " used)"}')"
            echo ""
            
            # 2. Check Node.js
            echo "2. NODE.JS STATUS"
            echo "-----------------"
            if command -v node &> /dev/null; then
              echo "✓ Node.js installed: $(node --version)"
              echo "✓ NPM installed: $(npm --version)"
            else
              echo "✗ Node.js NOT installed"
            fi
            echo ""
            
            # 3. Check PostgreSQL
            echo "3. POSTGRESQL STATUS"
            echo "--------------------"
            if command -v psql &> /dev/null; then
              echo "✓ PostgreSQL installed: $(psql --version | head -1)"
              if systemctl is-active --quiet postgresql; then
                echo "✓ PostgreSQL service is RUNNING"
                sudo -u postgres psql -c "SELECT version ();" 2>&1 | head -2 || echo "✗ Cannot connect to PostgreSQL"
              else
                echo "✗ PostgreSQL service is STOPPED"
              fi
            else
              echo "✗ PostgreSQL NOT installed"
            fi
            echo ""
            
            # 4. Check Nginx
            echo "4. NGINX STATUS"
            echo "---------------"
            if command -v nginx &> /dev/null; then
              echo "✓ Nginx installed: $(nginx -v 2>&1)"
              if systemctl is-active --quiet nginx; then
                echo "✓ Nginx service is RUNNING"
                sudo nginx -t 2>&1 | grep -E "successful|failed"
              else
                echo "✗ Nginx service is STOPPED"
              fi
            else
              echo "✗ Nginx NOT installed"
            fi
            echo ""
            
            # 5. Check PM2
            echo "5. PM2 PROCESS STATUS"
            echo "---------------------"
            if command -v pm2 &> /dev/null; then
              echo "✓ PM2 installed: $(pm2 --version)"
              pm2 list
              echo ""
              pm2 info comments-api 2>/dev/null || echo "✗ comments-api process NOT found in PM2"
            else
              echo "✗ PM2 NOT installed"
            fi
            echo ""
            
            # 6. Check Application Directory
            echo "6. APPLICATION FILES"
            echo "--------------------"
            APP_DIR="/home/$USER/comments-app"
            if [ -d "$APP_DIR" ]; then
              echo "✓ Application directory exists: $APP_DIR"
              if [ -d "$APP_DIR/.git" ]; then
                cd $APP_DIR
                echo "✓ Git repository found"
                echo "  Current branch: $(git branch --show-current)"
                echo "  Latest commit: $(git log -1 --oneline)"
              else
                echo "✗ Not a git repository"
              fi
              
              if [ -d "$APP_DIR/server" ]; then
                echo "✓ Server directory exists"
                if [ -f "$APP_DIR/server/.env" ]; then
                  echo "✓ .env file exists"
                  echo "  Variables configured:"
                  cat $APP_DIR/server/.env | grep -v "PASSWORD\|SECRET\|KEY" | grep "=" | cut -d= -f1 | sed 's/^/    - /'
                else
                  echo "✗ .env file MISSING"
                fi
                
                if [ -d "$APP_DIR/server/node_modules" ]; then
                  echo "✓ node_modules installed"
                else
                  echo "✗ node_modules MISSING"
                fi
              else
                echo "✗ Server directory MISSING"
              fi
            else
              echo "✗ Application directory MISSING"
            fi
            echo ""
            
            # 7. Check Port 3000
            echo "7. PORT STATUS"
            echo "--------------"
            if sudo netstat -tlnp 2>/dev/null | grep -q ":3000"; then
              echo "✓ Port 3000 is LISTENING"
              sudo netstat -tlnp | grep ":3000"
            else
              echo "✗ Port 3000 is NOT listening"
            fi
            echo ""
            
            # 8. Test Local Connection
            echo "8. LOCAL API TEST"
            echo "-----------------"
            if curl -s -m 5 http://localhost:3000/health > /dev/null 2>&1; then
              echo "✓ Local API responding on http://localhost:3000/health"
              curl -s http://localhost:3000/health | head -5
            else
              echo "✗ Local API NOT responding"
            fi
            echo ""
            
            # 9. Check SSL Certificate
            echo "9. SSL CERTIFICATE"
            echo "------------------"
            if [ -d "/etc/letsencrypt/live/api.sarcasticrobo.online" ]; then
              echo "✓ SSL certificate directory exists"
              sudo certbot certificates 2>&1 | grep -A5 "api.sarcasticrobo.online" || echo "  Cannot read certificate info"
            else
              echo "✗ SSL certificate NOT found"
            fi
            echo ""
            
            # 10. Check Recent Logs
            echo "10. RECENT PM2 LOGS (Last 20 lines)"
            echo "------------------------------------"
            if command -v pm2 &> /dev/null; then
              pm2 logs comments-api --lines 20 --nostream 2>/dev/null || echo "No logs available"
            fi
            echo ""
            
            echo "========================================="
            echo "ATTEMPTING AUTO-FIX"
            echo "========================================="
            echo ""
            
            # Auto-fix: Start PostgreSQL if stopped
            if ! systemctl is-active --quiet postgresql; then
              echo "→ Starting PostgreSQL..."
              sudo systemctl start postgresql && echo "  ✓ PostgreSQL started" || echo "  ✗ Failed to start PostgreSQL"
            fi
            
            # Auto-fix: Start Nginx if stopped
            if ! systemctl is-active --quiet nginx; then
              echo "→ Starting Nginx..."
              sudo systemctl start nginx && echo "  ✓ Nginx started" || echo "  ✗ Failed to start Nginx"
            fi
            
            # Auto-fix: Pull latest code
            if [ -d "$APP_DIR/.git" ]; then
              echo "→ Pulling latest code..."
              cd $APP_DIR
              git pull origin main && echo "  ✓ Code updated" || echo "  ✗ Failed to pull code"
            fi
            
            # Auto-fix: Install dependencies
            if [ -d "$APP_DIR/server" ] && [ ! -d "$APP_DIR/server/node_modules" ]; then
              echo "→ Installing Node.js dependencies..."
              cd $APP_DIR/server
              npm install --production && echo "  ✓ Dependencies installed" || echo "  ✗ Failed to install dependencies"
            fi
            
            # Auto-fix: Update .env if needed
            if [ -d "$APP_DIR/server" ]; then
              cd $APP_DIR/server
              if [ ! -f ".env" ]; then
                echo "→ Creating .env file..."
                cat > .env << EOF
          NODE_ENV=production
          PORT=3000
          DB_HOST=localhost
          DB_PORT=5432
          DB_NAME=comments_db
          DB_USER=comments_user
          DB_PASSWORD=${DB_PASSWORD:-change_me}
          GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID
          GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET
          GOOGLE_CALLBACK_URL=https://api.sarcasticrobo.online/auth/google/callback
          GEMINI_API_KEY=$GEMINI_API_KEY
          JWT_SECRET=$(openssl rand -base64 32)
          SESSION_SECRET=$(openssl rand -base64 32)
          FRONTEND_URL=https://deepak4395.github.io/Comments
          EOF
                chmod 600 .env
                echo "  ✓ .env file created"
              fi
            fi
            
            # Auto-fix: Restart PM2 process
            if command -v pm2 &> /dev/null; then
              if pm2 describe comments-api &> /dev/null; then
                echo "→ Restarting PM2 process..."
                cd $APP_DIR/server
                pm2 restart comments-api && echo "  ✓ Process restarted" || echo "  ✗ Failed to restart"
              else
                echo "→ Starting PM2 process..."
                cd $APP_DIR/server
                pm2 start src/index.js --name comments-api
                pm2 save
                echo "  ✓ Process started"
              fi
            fi
            
            # Final test
            echo ""
            echo "========================================="
            echo "FINAL VERIFICATION"
            echo "========================================="
            sleep 3
            
            if curl -s -m 5 http://localhost:3000/health > /dev/null 2>&1; then
              echo "✓✓✓ SUCCESS! Backend is now responding ✓✓✓"
              echo ""
              curl -s http://localhost:3000/health
            else
              echo "✗✗✗ FAILED! Backend still not responding ✗✗✗"
              echo ""
              echo "Manual intervention required. Check:"
              echo "1. Database connection"
              echo "2. Environment variables"
              echo "3. PM2 logs: pm2 logs comments-api"
            fi
            
          ENDSSH

      - name: Test External Access
        run: |
          echo ""
          echo "========================================="
          echo "EXTERNAL API TEST"
          echo "========================================="
          sleep 5
          if curl -s -m 10 https://api.sarcasticrobo.online/health > /dev/null 2>&1; then
            echo "✓✓✓ SUCCESS! API is accessible from internet ✓✓✓"
            echo ""
            curl -s https://api.sarcasticrobo.online/health
          else
            echo "✗ API not accessible from internet (may need SSL/DNS configuration)"
          fi
